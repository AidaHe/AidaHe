<!DOCTYPE html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="仿App Store转场动画 Swift语言实现"><meta name="author" content="AidaHe"><meta name="keywords" content="Swift,App Store,Transition"><meta name="copyright" content="copyright.liscense_type"><title>仿App Store转场动画 Swift语言实现</title><!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]><script src="https://cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script><script src="https://cdn.bootcss.com/respond/1.4.2/respond.min.js"></script><![endif]--><link rel="icon" href="/compass/imgs/favicon.ico"><link rel="stylesheet" href="/compass/stylesheets/font-awesome.min.css"><script>var algoliaConfig = {"on":false}</script><meta name="generator" content="Hexo 4.2.0"></head><link rel="stylesheet" href="/compass/stylesheets/screen.css"><!--link(rel='stylesheet' href='/compass/stylesheets/prism.css')--><body><div id="body-inner-wrapper"><header id="page-header"><nav id="nav"><div id="site-name">AidaHe‘s blog</div><i class="fa fa-bars fa-2x" id="nav-icon" aria-hidden="true"></i><div id="nav-expanded"><a class="nav-word-item" href="/">主页</a><a class="nav-word-item" href="/archives">归档</a><a class="nav-word-item" href="/tags">标签</a><a class="nav-word-item" href="/categories">分类</a><a class="nav-word-item" href="/about">关于</a></div><div id="nav-list"><ul><li><a class="nav-list-item" href="/">主页</a></li><li><a class="nav-list-item" href="/archives">归档</a></li><li><a class="nav-list-item" href="/tags">标签</a></li><li><a class="nav-list-item" href="/categories">分类</a></li><li><a class="nav-list-item" href="/about">关于</a></li></ul></div></nav><div id="banner-wrapper"><div id="banner-pagetype-dependent-info"><h1 id="post-title">仿App Store转场动画 Swift语言实现</h1><span id="post-description"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-17</span><span id="word-count">全文共 1603 字</span><span id="time-count">需阅读时间约 6 分钟</span></div></div><a title="回到顶部"><i class="fa fa-arrow-up" id="to-Top" aria-hidden="true"></i></a><a title="点击关闭目录"><i class="fa fa-toggle-on" id="toggle-on-Toc" aria-hidden="true"></i></a><a title="点击展开目录"><i class="fa fa-toggle-off" id="toggle-off-Toc" aria-hidden="true"></i></a></header><aside id="toc-column"><div id="toc-column-inner-wrapper"><div id="post-toc"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#参考文档："><span class="toc-text">参考文档：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#效果图："><span class="toc-text">效果图：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#场景分析："><span class="toc-text">场景分析：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#代码实现："><span class="toc-text">代码实现：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#一、重写Push、实现Delegate"><span class="toc-text">一、重写Push、实现Delegate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二、将首页截图传递给详情页备用"><span class="toc-text">二、将首页截图传递给详情页备用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三、详情页添加左滑返回手势"><span class="toc-text">三、详情页添加左滑返回手势</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol></div></div></aside><main id="main-content-column"><div id="main-content-wrapper"><div id="post-full-content"><h3 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h3><blockquote>
<p><a href="https://www.jianshu.com/p/d802eb2e5a31" target="_blank" rel="noopener">https://www.jianshu.com/p/d802eb2e5a31</a><br>本文主体思路是参考该博主的OC版本实现的<br><a href="https://www.jianshu.com/p/8a99020d954f" target="_blank" rel="noopener">https://www.jianshu.com/p/8a99020d954f</a><br>此文章介绍了转场动画中相关的一些概念，我感觉还是挺通俗易懂的。</p>
</blockquote>
<h3 id="效果图："><a href="#效果图：" class="headerlink" title="效果图："></a>效果图：</h3><p><img src="https://upload-images.jianshu.io/upload_images/6695792-899f9bb7318751e1.gif?imageMogr2/auto-orient/strip" alt="效果图"></p>
<a id="more"></a>

<h3 id="场景分析："><a href="#场景分析：" class="headerlink" title="场景分析："></a>场景分析：</h3><p>1、某日，我看到App Store上首页花里胡哨的转场动画体验着实不错，便想着自己实现一番。<br>2、作为一个萌新看到这样的效果完全联想不到是用何等操作实现的，so，百度，于是找到一个OC版。<br>3、然后也知道此效果主要是通过重写系统的<code>push</code>、<code>pop</code>动画达到的。作为一个<code>Swift</code>偏好者，难免不想翻译一下。<br>4、既然是需要<code>push</code>、<code>pop</code>，那么第一步是需要<code>navigationController</code>，我是直接在<code>StoryBoard</code>中嵌入的。<br>5、接下来是首页<code>TableView</code>布局，<code>cell</code>触摸缩小放大。<br>6、点击<code>cell Push</code>到详情页，本文重点，先放到后面再详说。<br>7、详情页依旧是<code>TableView</code>布局。顶部大图为<code>Header</code>，底部为文本，动态计算高度即可。<br>8、详情页伴随着左滑手势将页面按一定比例缩小，当缩小一定程度时<code>Pop</code>回首页。<br>9、不难发现，在详情页左滑时还有一个模糊的背景正是首页的截图。</p>
<h3 id="代码实现："><a href="#代码实现：" class="headerlink" title="代码实现："></a>代码实现：</h3><p>除了不知道如何重写<code>pop</code>和<code>push</code>之外其余思路清晰之后，便可以开始绘制基本UI了<br><img src="https://upload-images.jianshu.io/upload_images/6695792-f666c487494066c5.gif?imageMogr2/auto-orient/strip" alt="系统push、pop效果"></p>
<h4 id="一、重写Push、实现Delegate"><a href="#一、重写Push、实现Delegate" class="headerlink" title="一、重写Push、实现Delegate"></a>一、重写Push、实现Delegate</h4><pre><code class="(Swift)">extension ViewController:UINavigationControllerDelegate,UIViewControllerAnimatedTransitioning{
    func transitionDuration(using transitionContext: UIViewControllerContextTransitioning?) -&gt; TimeInterval {
        return 1.0
    }

    func navigationController(_ navigationController: UINavigationController, animationControllerFor operation: UINavigationController.Operation, from fromVC: UIViewController, to toVC: UIViewController) -&gt; UIViewControllerAnimatedTransitioning?{
        return self
    }

    func animateTransition(using transitionContext: UIViewControllerContextTransitioning) {
    }
}</code></pre>
<p>此时我们再来仔细观察从首页点击<code>cell</code>之后<code>push</code>到详情页这之间发生了什么？不难发现，其实就是将<code>cell</code>放大，有一种弹出的效果，而系统的<code>push</code>默认效果是新页面从左边覆盖过来。</p>
<blockquote>
<p>其实呢，在转场的过程中系统会提供一个视图容器用来盛装进行跳转控制器的视图，如下图所示，当前的<code>FirstViewController</code> <code>present</code>到<code>SecondViewController</code>的时候，此时，<code>FirstViewController</code>的<code>view</code>变成<code>fromView</code>，这个视图会自动加入到<code>transtition container view</code>中，然后在跳转过程中我们需要做的就是将<code>SecondViewController</code>的视图（此时是toView）加入到这个容器中，然后为这个toView的展现增加动画。<br>以上内容摘录自此处<br>作者：劉光軍_Shine<br>链接：<a href="https://www.jianshu.com/p/8a99020d954f" target="_blank" rel="noopener">https://www.jianshu.com/p/8a99020d954f</a><br>來源：简书</p>
</blockquote>
<p>有了一定概念之后，我们来解读一下下面的逻辑<br>1、拿到<code>toView</code>:即将要展示的视图，<code>fromView</code>:当前页面已展示的<code>view</code><br>2、拿到<code>toView,fromView</code>之后，即将要展示动画，先将<code>fromView</code>隐藏，操作<code>toView</code>的<code>frame</code>和<code>alpha</code>以达到弹出放大的效果<br>3、将需要展示动画的<code>view</code>设置相应位置之后添加到<code>transitionContext</code>中<br>4、展示动画<code>toView.alpha 0~&gt;1</code> 逐渐显示，<code>frame</code> 首页<code>cell frame~&gt;</code> 详情页<code>header frame</code> 逐渐放大<br>5、移除用于展示动画的<code>view</code>，显示详情页<code>view</code>，显示首页<code>view</code></p>
<pre><code class="Swift">func animateTransition(using transitionContext: UIViewControllerContextTransitioning) {

        let cell:HomeTableViewCell = tableView.cellForRow(at: selectIndexPath!) as! HomeTableViewCell
        let toVC:UIViewController = transitionContext.viewController(forKey: .to)!
        let toView:UIImageView = toVC.value(forKeyPath:&quot;headerImageView&quot;) as! UIImageView
        let fromView = cell.bgView

        let containerView = transitionContext.containerView
        let snapshotView = UIImageView(image: cell.bgImageView!.image)
        snapshotView.frame = containerView.convert((fromView?.frame)!, from: fromView?.superview)

        fromView?.isHidden = true
        toVC.view.frame = transitionContext.finalFrame(for: toVC)
        toVC.view.alpha = 0
        toView.isHidden = true

        let titleLabel = UILabel(frame: CGRect(x: 15, y: 20, width: kScreenWidth-30, height: 30))
        titleLabel.textColor = UIColor.white
        titleLabel.font = UIFont.boldSystemFont(ofSize: 25)
        titleLabel.text = cell.titleLabel?.text

        let contentLabel = UILabel(frame: CGRect(x: 15, y: (kScreenWidth-40)*1.3-30, width: kScreenWidth-30, height: 15))
        contentLabel.textColor = UIColor.white
        contentLabel.text = cell.contentLabel?.text
        contentLabel.font = UIFont(name: &quot;PingFangSC-Light&quot;, size: 15)
        contentLabel.alpha = 0.5
        snapshotView.addSubview(titleLabel)
        snapshotView.addSubview(contentLabel)

        containerView.addSubview(toVC.view)
        containerView.addSubview(snapshotView)

        UIView.animate(withDuration: self.transitionDuration(using: transitionContext), delay: 0.0, usingSpringWithDamping: 0.6, initialSpringVelocity: 1.0, options: .curveLinear, animations: {
                    containerView.layoutIfNeeded()
                    toVC.view.alpha = 1.0
                    self.view.frame = CGRect(x: 0, y: 0, width: kScreenWidth, height: kScreenHeight)
                    snapshotView.frame = containerView.convert(toView.frame, from: toView.superview)
                    titleLabel.frame = CGRect(x: 22, y: 30, width: kScreenWidth - 30, height: 30)
                    contentLabel.frame = CGRect(x: 22, y: kScreenWidth*1.3-30, width: kScreenWidth*1.3-44, height: 15)

                }) { (finished) in

                    toView.isHidden = false
                    fromView?.isHidden = false
                    snapshotView.removeFromSuperview()
                    self.tableView.reloadData()
                    transitionContext.completeTransition(true)
                }

    }</code></pre>
<h4 id="二、将首页截图传递给详情页备用"><a href="#二、将首页截图传递给详情页备用" class="headerlink" title="二、将首页截图传递给详情页备用"></a>二、将首页截图传递给详情页备用</h4><pre><code class="(swift)">//MARK: 截屏
    func imageFromView() -&gt;UIImage{
        UIGraphicsBeginImageContext(self.view.frame.size)
        let context = UIGraphicsGetCurrentContext()
        self.view.layer.render(in: context!)
        let image = UIGraphicsGetImageFromCurrentImageContext()
        UIGraphicsEndImageContext()

        return image!
    }</code></pre>
<h4 id="三、详情页添加左滑返回手势"><a href="#三、详情页添加左滑返回手势" class="headerlink" title="三、详情页添加左滑返回手势"></a>三、详情页添加左滑返回手势</h4><p>1、给详情页的<code>tableView</code>添加手势<br>2、滑动过程中，实时获取当前滑动位置到初始位置的距离，实时计算该距离占据屏幕比例，相应缩小<code>tableView</code>大小并添加适应的圆角<br>3、手势结束时，获取手势发生的开始位置，手势结束后获取结束位置，计算出总共滑动范围<br>4、依据滑动范围所占屏幕的比例从而决定是否<code>pop</code>回上一页。若比例达到返回上一页，重写<code>pop</code>动画与<code>push</code>类似。若比例未达到，恢复详情页<code>tableView frame</code></p>
<pre><code class="(swift)">@objc func handleGesture(_ sender:UIGestureRecognizer){

        weak var weakSelf = self

        switch sender.state {
        case .began:
            print(&quot;手势开始---&quot;)
            let currentPoint = sender.location(in: self.detailTableView)
            startPointX = currentPoint.x
            startPointY = currentPoint.y
            isHorizontal = (startPointX &gt; CGFloat(30)) ? false : true
            break
        case .changed:
            print(&quot;拖动中----&quot;)
            let currentPoint = sender.location(in: self.detailTableView)

            if isHorizontal {
                if ((currentPoint.x-startPointX)&gt;(currentPoint.y-startPointY)) {
                    scale = (kScreenWidth-(currentPoint.x-startPointX))/kScreenWidth
                } else {
                    scale = (kScreenHeight-(currentPoint.y-startPointY))/kScreenHeight
                }
            } else {
                scale = (kScreenHeight-(currentPoint.y-startPointY))/kScreenHeight
            }

            if (scale &gt; CGFloat(1)) {
                scale = CGFloat(1)
            } else if (scale &lt;= CGFloat(0.8)) {
                scale = CGFloat(0.8);
            }
            if (self.detailTableView!.contentOffset.y&lt;=0) {
                // 缩放
                self.detailTableView!.transform = CGAffineTransform(scaleX: scale, y: scale)
                // 圆角
                self.detailTableView!.layer.cornerRadius = 15 * (1-scale)*5*1.08;
            }

            self.detailTableView!.isScrollEnabled = (scale &lt; 0.99) ? false : true
            break
        case .ended:
            print(&quot;手势结束--&quot;)
            if(scale == 0.8){
                DispatchQueue.main.asyncAfter(deadline: .now()+0.5) {
                    weakSelf?.navigationController?.popViewController(animated: true)
                }
            }

            self.detailTableView!.isScrollEnabled = true
            if scale &gt; CGFloat(0.8) {
                UIView.animate(withDuration: 0.2) {
                    weakSelf?.detailTableView!.layer.cornerRadius = 0
                    weakSelf?.detailTableView!.transform = CGAffineTransform(scaleX: 1, y: 1)
                }

            }
            break
        default:
            break
        }</code></pre>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>1、如果实际开发中多处需要用到这种转场效果可以抽出一个工具类来。<br>2、其实<code>App Store</code>中<code>pop</code>回来还有一个效果就是返回到首页时下面的文字说明会像一个抽屉一样由下往上收回的效果，有时间再去研究一下。另外，<code>App Store</code>上的背景配色之类一些细节处理也是非常极致的，有兴趣的朋友可以继续深究。<br>3、如有不足之处，望各路大神斧正。<br>4、<a href="https://github.com/SingletonH/SwiftTransition.git" target="_blank" rel="noopener">源码地址：https://github.com/SingletonH/SwiftTransition.git</a></p>
</div><div id="post-tags-container"><i class="fa fa-tags"></i> <a class="post-tag" href="/tags/Swift/">#Swift</a>  <a class="post-tag" href="/tags/App-Store/">#App Store</a>  <a class="post-tag" href="/tags/Transition/">#Transition</a></div><div id="post-categories-container"><i class="fa fa-folder-open"></i>
 <a href="/categories/Swift/">Swift</a></div></div></main><div id="pagination-wrapper"><a id="page-prev" href="/2020/05/24/2020/05/Navigation/"><i class="fa fa-chevron-left"></i> iOS 跳转高德，百度，腾讯，谷歌，苹果地图导航</a><a id="page-next" href="/2020/05/09/2020/05/SwiftExtension/">Swift中的Extension <i class="fa fa-chevron-right"></i></a></div><footer id="page-footer"><div id="footer-wrapper"><div id="blog-meta">&copy;2017-2020 By AidaHe | 主题 - <a id='theme-name' href="https://github.com/huan555/lemon-lime" target="_blank" rel="noopener"> Lemon-Lime</a> | 驱动 - <a id='theme-powered-by' href=http://hexo.io> Hexo</a></div><div id="viewed-record"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span></span></div><div id="copyright-wrapper"><i class="fa fa-cc" aria-hidden="true"></i><div id="copyright">除非有特别声明，本博客所有文章均采用 <a rel="license" href=http://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0 协议</a>.</div></div><div id="contact-me"><div id="rss"><a href="/atom.xml" type="application/atom+xml" rel="alternate" target="_blank"><i class="fa fa-rss" aria-hidden="true"></i></a></div><span id="github"><a href="https://github.com/AidaHe" target="_blank" rel="noopener"><i class="fa fa-github" aria-hidden="true"></i></a></span></div></div></footer><script src="/compass/js/blog.js"></script><!--script(src='/compass/js/prism.js')--></div></body>